RocketMQ发送普通消息有三种实现方式：

- 可靠同步发送（sync）
- 可靠异步发送（async）
- 单向（Oneway）发送。（oneway）

**同步**：发送者向MQ执行发送消息API时，同步等待，直到消息服务器返回发送结果。

**异步**：发送者向MQ执行发送消息API时，指定消息发送成功后的回掉函数，然后调用消息发送API后，立即返回，消息发送者线程不阻塞，直到运行结束，消息发送成功或失败的回调任务在一个新的线程中执行。

**单向**：消息发送者向MQ执行发送消息API时，直接返回，不等待消息服务器的结果，也不注册回调函数，简单地说，就是只管发，不在乎消息是否成功存储在消息服务器上。

RocketMQ消息发送需要考虑以下几个问题。

□ 消息队列如何进行负载？

□ 消息发送如何实现高可用？

□ 批量消息发送如何实现一致性？



RocketMQ消息封装类是org.apache.rocketmq.common.message.Message.

Message的基础属性主要包括消息所属主题topic、消息Flag（RocketMQ不做处理）、扩展属性、消息体。

tag：消息TAG，用于消息过滤。

keys:Message索引键，多个用空格隔开，RocketMQ可以根据这些key快速检索到消息。

waitStoreMsgOK：消息发送时是否等消息存储完成后再返回。

delayTimeLevel：消息延迟级别，用于定时消息或消息重试。



## 1.生产者启动流程



### 1.1DefaultMQProducer消息发送者



DefaultMQProducer是默认的消息生产者实现类.

producerGroup：生产者所属组，消息服务器在回查事务状态时会随机选择该组中任何一个生产者发起事务回查请求。



### 1.2 消息发送基本流程

消息发送流程主要的步骤：验证消息、查找路由、消息发送（包含异常处理机制）。

DefaultMQProducer#send



消息发送之前，首先确保生产者处于运行状态，然后验证消息是否符合相应的规范，具体的规范要求是主题名称、消息体不能为空、消息长度不能等于0且默认不能超过允许发送消息的最大长度4M（maxMessageSize=1024 * 1024 * 4）。



**消息长度验证**:

消息发送之前，首先确保生产者处于运行状态，然后验证消息是否符合相应的规范，具体的规范要求是主题名称、消息体不能为空、消息长度不能等于0且默认不能超过允许发送消息的最大长度4M（maxMessageSize=1024 * 1024 * 4）。

**查找主题路由信息**:

消息发送之前，首先需要获取主题的路由信息，只有获取了这些信息我们才知道消息要发送到具体的Broker节点。

